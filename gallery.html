<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>URJA — Gallery</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* minimal debug styles */
    #debugJson { background:#111;color:#0f0;padding:8px;margin:10px 0;white-space:pre-wrap;word-break:break-word; }
    .debug-error { background:#400;color:#fff;padding:8px;margin:10px 0; }
    .debug-note { background:#eef;padding:8px;margin:10px 0; color:#333; border-radius:6px; }
  </style>
</head>
<body class="animated-body">
<header class="site-header">
  <div class="container nav">
    <a class="brand" href="index.html">
      <img class="brand-mark" src="assets/urja_logo.png" alt="URJA logo">
      <div>
        <div class="brand-text">URJA</div>
        <div class="brand-sub">Tech & Culture Fest</div>
      </div>
    </a>
    <button class="nav-toggle" aria-label="Open menu" aria-expanded="false">☰</button>
    <nav id="nav-menu" class="nav-menu">
      <a href="index.html">Home</a>
      <a href="event-info.html">Events</a>
      <a href="schedule.html">Schedule</a>
      <a class="active" href="gallery.html">Gallery</a>
      <a href="team.html">Teams</a>
      <a href="sponsors.html">Sponsors</a>
    </nav>
  </div>
</header>

<main id="main">
  <section class="section page-hero">
    <div class="container">
      <h1>Gallery</h1>
      <p class="lead">Explore moments captured from URJA 2025. Select an event to view its photos.</p>
      <div class="upload-info" style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 1rem; border-radius: 12px; margin-top: 1rem;">
        <h3 style="margin: 0 0 0.5rem 0; color: #007bff;">For Event Heads:</h3>
        <p style="margin: 0; font-size: 0.9rem; color: #666;">
          Upload photos directly to your event's Google Drive folder. Contact admin for folder access.
        </p>
      </div>
    </div>
  </section>

  <section class="section">
    <div class="container">
      <div class="event-filters">
        <button class="filter-btn active" data-event="all">All Events</button>
        <button class="filter-btn" data-event="aavishar">Aavishar</button>
        <button class="filter-btn" data-event="abhivyakthi">Abhivyakthi</button>
        <button class="filter-btn" data-event="code-to-circuit">Code to Circuit</button>
        <button class="filter-btn" data-event="cultural">Cultural Events</button>
        <button class="filter-btn" data-event="sports">Sports</button>
        <button class="filter-btn" data-event="workshops">Workshops</button>
        <button class="filter-btn" data-event="competitions">Competitions</button>
      </div>
    </div>
  </section>

  <section class="section">
    <div class="container">
      <div id="eventTitle" class="event-title">All Events</div>

      <!-- Debug JSON will appear here -->
      <div id="debugJson" style="display:none;"></div>

      <!-- Error or notes -->
      <div id="debugNote" class="debug-note" style="display:none;"></div>

      <div class="cards-grid gallery-grid" id="galleryContainer">
        <div class="gallery-loading">Loading gallery...</div>
      </div>
    </div>
  </section>
</main>

<!-- Lightbox Modal (kept minimal) -->
<div id="lightbox" class="lightbox-overlay" style="display: none;" role="dialog" aria-hidden="true" aria-modal="true">
  <div class="lightbox-content">
    <button class="lightbox-close" aria-label="Close lightbox">✕</button>
    <img id="lightboxImage" src="" alt="Gallery image">
    <div class="lightbox-nav">
      <button class="lightbox-prev" aria-label="Previous image">‹</button>
      <button class="lightbox-next" aria-label="Next image">›</button>
    </div>
    <div class="lightbox-counter">
      <span id="lightboxCounter">1 / 1</span>
    </div>
    <div class="lightbox-info">
      <span id="lightboxEventName"></span>
    </div>
  </div>
</div>

<footer class="site-footer">
  <div class="container">
    <p>© <span id="year"></span> URJA - All Rights Reserved</p>
  </div>
</footer>

<style>
/* trimmed styles from previous file to keep things readable */
.event-filters{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-bottom:1rem}
.filter-btn{padding:8px 12px;border-radius:20px;border:1px solid #e0e0e0;background:#fff;cursor:pointer}
.filter-btn.active{background:#007bff;color:#fff;border-color:#007bff}
.gallery-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
.gallery-item img{width:100%;height:200px;object-fit:cover;border-radius:8px}
.gallery-loading{padding:20px;text-align:center;color:#666}
</style>

<script>
/*
  Simplified gallery front-end:
  - Uses photo.url returned by simple-gallery-data function
  - Shows debug JSON so you can see exactly what was returned
  - If images fail, shows clear message per image
*/

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('year').textContent = new Date().getFullYear();
  setupEventFilters();
  initializeGallery();
  setupLightbox();
});

const eventConfig = {
  aavishar: { name: 'Aavishar', folderId: '11KRFPRVckNxKhe-JcLN5s2fn3MyDPQ0E' },
  abhivyakthi: { name: 'Abhivyakthi', folderId: '1TZxfmQc9H3hbtx_uwlB44kJxiXj5LZRd' },
  'code-to-circuit': { name: 'Code to Circuit', folderId: '1FiETIIB3dxuzdEp7kw9FHQuIWLHLLzBC' },
  cultural: { name: 'Cultural Events', folderId: '' },
  sports: { name: 'Sports', folderId: '' },
  workshops: { name: 'Workshops', folderId: '' },
  competitions: { name: 'Competitions', folderId: '' }
};

let galleryImages = [];
let currentImageIndex = 0;

function setupEventFilters() {
  const btns = document.querySelectorAll('.filter-btn');
  btns.forEach(btn => btn.addEventListener('click', () => {
    btns.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const ev = btn.dataset.event;
    displayGallery(ev);
  }));
}

async function initializeGallery() {
  // initial load: all
  await displayGallery('all');
}

async function displayGallery(eventFilter) {
  const container = document.getElementById('galleryContainer');
  const eventTitle = document.getElementById('eventTitle');
  document.getElementById('debugJson').style.display = 'none';
  document.getElementById('debugNote').style.display = 'none';

  container.innerHTML = '<div class="gallery-loading">Loading photos...</div>';
  galleryImages = [];

  // title
  eventTitle.textContent = eventFilter === 'all' ? 'All Events' : (eventConfig[eventFilter]?.name || 'Event Photos');

  try {
    if (eventFilter === 'all') {
      // load each configured event sequentially (safe for mobile)
      for (const key of Object.keys(eventConfig)) {
        const cfg = eventConfig[key];
        if (!cfg.folderId) continue;
        const photos = await fetchPhotosForFolder(cfg.folderId, key);
        galleryImages.push(...photos);
      }
    } else {
      const cfg = eventConfig[eventFilter];
      if (cfg && cfg.folderId) {
        const photos = await fetchPhotosForFolder(cfg.folderId, eventFilter);
        galleryImages.push(...photos);
      }
    }
    renderImages();
  } catch (err) {
    container.innerHTML = '<div class="gallery-loading">Error loading photos. Try again later.</div>';
    console.error('displayGallery error', err);
  }
}

async function fetchPhotosForFolder(folderId, eventKey) {
  const container = document.getElementById('galleryContainer');
  try {
    const res = await fetch(`/.netlify/functions/simple-gallery-data?folderId=${encodeURIComponent(folderId)}`);
    if (!res.ok) {
      const text = await res.text();
      const errEl = document.createElement('div');
      errEl.className = 'debug-error';
      errEl.textContent = `Failed to load ${eventKey}: ${res.status} ${text}`;
      container.appendChild(errEl);
      return [];
    }

    const json = await res.json();

    // show debug JSON (first event only to avoid clutter)
    const debug = document.getElementById('debugJson');
    debug.style.display = 'block';
    debug.textContent = `DEBUG ${eventKey}: ${JSON.stringify(json, null, 2)}`;

    // map to front-end shape (use url field returned by function)
    return (json || []).map(p => ({
      src: p.url,
      name: p.name,
      event: eventKey,
      alt: `${eventConfig[eventKey]?.name || eventKey} — ${p.name}`
    }));
  } catch (err) {
    const errEl = document.createElement('div');
    errEl.className = 'debug-error';
    errEl.textContent = `Exception loading ${eventKey}: ${err.message || err}`;
    document.getElementById('galleryContainer').appendChild(errEl);
    return [];
  }
}

function renderImages() {
  const container = document.getElementById('galleryContainer');
  container.innerHTML = '';

  if (galleryImages.length === 0) {
    container.innerHTML = '<div class="gallery-loading">No photos available yet. Check back soon!</div>';
    return;
  }

  galleryImages.forEach((imgObj, i) => {
    const item = document.createElement('div');
    item.className = 'gallery-item';

    const img = document.createElement('img');
    img.src = imgObj.src; // THIS IS KEY: using the direct Drive "uc?export=view&id=" URL
    img.alt = imgObj.alt;
    img.loading = 'lazy';

    // on error, show explanatory message below the failed image
    img.addEventListener('error', () => {
      const note = document.createElement('div');
      note.className = 'debug-error';
      note.textContent = `Failed to load image. Open this URL in a new tab to check permissions: ${imgObj.src}`;
      item.appendChild(note);
      img.src = 'https://via.placeholder.com/400x300/cccccc/666666?text=Image+Error';
    });

    const caption = document.createElement('div');
    caption.style.fontSize = '12px';
    caption.style.color = '#666';
    caption.style.marginTop = '6px';
    caption.textContent = `${imgObj.event} — ${imgObj.name}`;

    item.appendChild(img);
    item.appendChild(caption);
    item.addEventListener('click', () => openLightbox(i));
    container.appendChild(item);
  });
}

/* lightbox basics */
function setupLightbox() {
  document.querySelector('.lightbox-close')?.addEventListener('click', closeLightbox);
  document.querySelector('.lightbox-prev')?.addEventListener('click', () => navigateLightbox(-1));
  document.querySelector('.lightbox-next')?.addEventListener('click', () => navigateLightbox(1));
}

function openLightbox(index) {
  if (!galleryImages.length) return;
  currentImageIndex = index;
  const box = document.getElementById('lightbox');
  const img = document.getElementById('lightboxImage');
  img.src = galleryImages[index].src;
  img.alt = galleryImages[index].alt;
  document.getElementById('lightboxCounter').textContent = `${index + 1} / ${galleryImages.length}`;
  document.getElementById('lightboxEventName').textContent = galleryImages[index].event;
  box.style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

function closeLightbox() {
  document.getElementById('lightbox').style.display = 'none';
  document.body.style.overflow = '';
}

function navigateLightbox(dir) {
  currentImageIndex += dir;
  if (currentImageIndex < 0) currentImageIndex = galleryImages.length - 1;
  if (currentImageIndex >= galleryImages.length) currentImageIndex = 0;
  openLightbox(currentImageIndex);
}
</script>

</body>
</html>